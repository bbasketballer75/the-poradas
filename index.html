<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Poradas Wedding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cormorant+Garamond:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDYCx_JthKAqyRNe5Mtwkx3INBY2MwxSxE",
      authDomain: "shared-wedding-album-11b45.firebaseapp.com",
      projectId: "shared-wedding-album-11b45",
      storageBucket: "shared-wedding-album-11b45.appspot.com",
      messagingSenderId: "720256701487",
      appId: "1:720256701487:web:78ceff3f5bb1f2de9b22da"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const db = firebase.database();
  </script>
</head>
<body>

  <section id="intro-section" style="width:100vw;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;position:relative;z-index:1;">
    <video id="intro-video" autoplay muted playsinline preload="auto" style="width:100vw;height:100vh;object-fit:contain;background:#fff;display:block;">
      <source src="video/intro.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <button id="skip-intro" type="button" style="pointer-events:auto;opacity:0;transition:opacity 0.5s;position:absolute;bottom:24px;right:24px;z-index:2;padding:0.3em 1em;line-height:1.2;font-size:0.95em;background:rgba(255,255,255,0.7);border:1px solid #ccc;border-radius:18px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.06);height:auto;min-height:unset;">Skip Intro</button>
    <button id="replay-intro" type="button" style="position:absolute;top:24px;right:24px;z-index:2;padding:0.3em 1em;line-height:1.2;font-size:0.95em;background:rgba(255,255,255,0.7);border:1px solid #ccc;border-radius:18px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.06);">Replay Intro</button>
  </section>

  <main id="main-content" style="display:none;">
    <section id="scroll-section">

    </section>

    <section id="family-tree" class="wedding-family-tree">
      <div class="family-tree-rows">
        <div class="family-tree-row couple-row">
          <div class="tree-person"><img src="images/austin.webp" alt="Austin" class="ring-couple"><span class="tree-person-name">Austin</span></div>
          <div class="tree-person"><img src="images/jordyn.webp" alt="Jordyn" class="ring-couple"><span class="tree-person-name">Jordyn</span></div>
        </div>
        <div class="family-tree-section-block">
          <div class="family-tree-section-title">Beloved Parents</div>
          <div class="family-tree-row">
            <div class="tree-person"><img src="images/parents/christine.webp" alt="Christine Pringle" class="ring-parent"><span class="tree-person-name">Christine Pringle</span></div>
            <div class="tree-person"><img src="images/parents/jerame.webp" alt="Jerame Pringle" class="ring-parent"><span class="tree-person-name">Jerame Pringle</span></div>
            <div class="tree-person"><img src="images/parents/heather.webp" alt="Heather Shaffer" class="ring-parent"><span class="tree-person-name">Heather Shaffer</span></div>
            <div class="tree-person"><img src="images/parents/melony.webp" alt="Melony Porada" class="ring-parent"><span class="tree-person-name">Melony Porada</span></div>
          </div>
        </div>
        <div class="family-tree-section-block">
          <div class="family-tree-section-title">Groomsmen</div>
          <div class="family-tree-row groomsmen">
            <div class="tree-person"><img src="images/wedding-party/groomsmen/tyler-sharpe.webp" alt="Tyler Sharpe" class="ring-groomsman"><span class="tree-person-name">Tyler Sharpe</span><div class="tree-person-role">Best Man</div></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/alex-molnar.webp" alt="Alex Molnar" class="ring-groomsman"><span class="tree-person-name">Alex Molnar</span></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/brosonan-mccray.webp" alt="Brosonan McCray" class="ring-groomsman"><span class="tree-person-name">Brosonan McCray</span></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/ean-pringle.webp" alt="Ean Pringle" class="ring-groomsman"><span class="tree-person-name">Ean Pringle</span></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/eddie-migut.webp" alt="Eddie Migut" class="ring-groomsman"><span class="tree-person-name">Eddie Migut</span></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/ian-porada.webp" alt="Ian Porada" class="ring-groomsman"><span class="tree-person-name">Ian Porada</span></div>
            <div class="tree-person"><img src="images/wedding-party/groomsmen/nate-berkebile.webp" alt="Nate Berkebile" class="ring-groomsman"><span class="tree-person-name">Nate Berkebile</span></div>
          </div>
        </div>
        <div class="family-tree-section-block">
          <div class="family-tree-section-title">Bridal Party</div>
          <div class="family-tree-row bridesmaids">
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/lexi-ferg.webp" alt="Lexi Ferg" class="ring-bridesmaid"><span class="tree-person-name">Lexi Ferg</span><div class="tree-person-role">Matron of Honor</div></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/brinnah-porada.webp" alt="Brinnah Porada" class="ring-bridesmaid"><span class="tree-person-name">Brinnah Porada</span></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/caitie-helsel.webp" alt="Caitie Helsel" class="ring-bridesmaid"><span class="tree-person-name">Caitie Helsel</span></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/emily-aurandt.webp" alt="Emily Aurandt" class="ring-bridesmaid"><span class="tree-person-name">Emily Aurandt</span></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/hannah-porada.webp" alt="Hannah Porada" class="ring-bridesmaid"><span class="tree-person-name">Hannah Porada</span></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/maria-mccray.webp" alt="Maria McCray" class="ring-bridesmaid"><span class="tree-person-name">Maria McCray</span><div class="tree-person-role">Officiant</div></div>
            <div class="tree-person"><img src="images/wedding-party/bridesmaids/mic.webp" alt="Mic" class="ring-bridesmaid"><span class="tree-person-name">Micaela Helsel</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="main-film-section">
      <h2 class="section-title">The Wedding Film</h2>
      <div id="main-film-player-container">
        <div id="video-play-overlay"></div>
        <video id="main-film-video" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" poster="images/main-film-poster.jpg" data-setup='{"fluid": true}'>
          <source src="https://pub-de1431994c6f481dbc54181e6b5462d3.r2.dev/final-wedding-video.mp4" type="video/mp4" />
          <track kind="chapters" src="https://pub-de1431994c6f481dbc54181e6b5462d3.r2.dev/main-film-chapters.vtt" srclang="en" label="Chapters" default>
        </video>
      </div>
    </section>

    <section id="engagement-album" class="album-section">
      <h2 class="section-title">Our Engagement</h2>
      <div class="horizontal-scroll-gallery">
        <img src="images/engagement/PoradaProposal-4.jpg" alt="Engagement 1" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-6.jpg" alt="Engagement 2" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-11.jpg" alt="Engagement 3" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-28.jpg" alt="Engagement 4" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-29.jpg" alt="Engagement 5" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-31.jpg" alt="Engagement 6" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-36.jpg" alt="Engagement 7" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-40.jpg" alt="Engagement 8" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-58.jpg" alt="Engagement 9" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-62.jpg" alt="Engagement 10" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-67.jpg" alt="Engagement 11" onerror="this.style.display='none'"/>
        <img src="images/engagement/PoradaProposal-75.jpg" alt="Engagement 12" onerror="this.style.display='none'"/>
      </div>
    </section>

    <section id="rings-section" class="album-section">
      <h2 class="section-title">Our Rings</h2>
      <div class="rings-row">
        <img src="images/rings/PoradaProposal-255.jpg" alt="Ring Detail 1" class="ring-img" onerror="this.style.display='none'"/>
        <img src="images/rings/PoradaProposal-259.jpg" alt="Ring Detail 2" class="ring-img" onerror="this.style.display='none'"/>
        <img src="images/rings/PoradaProposal-262.jpg" alt="Ring Detail 3" class="ring-img" onerror="this.style.display='none'"/>
        <img src="images/rings/PoradaProposal-268.jpg" alt="Ring Detail 4" class="ring-img" onerror="this.style.display='none'"/>
      </div>
    </section>

    <section id="shared-album-section" class="album-section">
      <h2 class="section-title">Share Your Photos</h2>
      <p class="section-subtitle">Help us remember the day! See photos from our guests below.</p>
      
      <!-- Gallery view comes first -->
      <div id="shared-photo-gallery" class="shared-gallery"></div>
      
      <!-- Upload form comes after the gallery -->
      <div class="upload-section">
        <h3 class="upload-title">Upload Your Photos</h3>
        <form id="photo-upload-form">
          <input type="text" id="photo-name" placeholder="Your Name" required />
          <input type="file" id="photo-file" accept="image/*" required />
          <button type="submit">Upload Photo</button>
        </form>
      </div>
    </section>

    <div class="guestbook-map-container">
      <section id="guestbook-section" class="album-section">
        <h2 class="section-title">Digital Guestbook</h2>
        <form id="guestbook-form">
          <input type="text" id="guest-name" placeholder="Your Name" required />
          <textarea id="guest-message" placeholder="Your Message" required></textarea>
          <button type="submit">Leave a Message</button>
        </form>
        <div id="guestbook-messages"></div>
      </section>
      <section id="map-section" class="album-section">
        <h2 class="section-title">Where Our Guests Are From</h2>
        <div id="guest-map" style="min-height:500px;background:#f5f5f5;border-radius:12px;border:1px solid #eee;"></div>
        <div id="manual-pin-area">
          <button id="manual-pin-btn" type="button">Drop a Pin on the Map</button>
          <div>If you didn't share your location, you can still add yourself!</div>
        </div>
        <script>
          // --- MAP DEBUGGING: Only log status, do NOT clear the map container ---
          (function() {
            var mapSection = document.getElementById('map-section');
            var guestMap = document.getElementById('guest-map');
            if (guestMap) {
              guestMap.style.display = 'block';
              guestMap.style.minHeight = '350px';
              guestMap.style.background = '#e6f2ff';
              guestMap.style.width = '100%';
              guestMap.style.border = '2px solid #b3d1ff';
              guestMap.style.position = 'relative';
              // guestMap.innerHTML = '';
              console.log('[MAP DEBUG] guest-map container forced visible.');
            } else {
              console.error('[MAP DEBUG] guest-map container NOT FOUND!');
            }
            if (typeof L === 'undefined') {
              console.error('[MAP DEBUG] Leaflet library (L) is NOT loaded!');
            } else {
              console.log('[MAP DEBUG] Leaflet library (L) is loaded.');
            }
          })();
        </script>
      </section>
    </div>
  </main>

  <!-- Footer will be injected after intro ends -->

  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const body = document.body;
      const mainContent = document.getElementById('main-content');
      const introSection = document.getElementById('intro-section');
      const introVideo = document.getElementById('intro-video');
      const skipBtn = document.getElementById('skip-intro');
      const replayBtn = document.getElementById('replay-intro');

      // Hide replay button until after intro
      replayBtn.style.display = 'none';

      // Disable scrolling during intro
      body.style.overflow = 'hidden';
      mainContent.style.display = 'none';
      skipBtn.style.opacity = 0;
      skipBtn.style.pointerEvents = 'auto';
      introVideo.muted = true;
      introVideo.setAttribute('muted', '');
      introVideo.load();
      let videoStarted = false;
      let skipTimeout;
      let fallbackTimeout;
      let introActive = true;

      function showSkipBtn() {
        skipBtn.style.opacity = 1;
        skipBtn.disabled = false;
      }

      let introWasSkipped = false;
      function endIntro() {
        // Failsafe: always show main content and re-initialize dynamic features (map, etc)
        mainContent.style.display = 'block';
        if (window.initializeDynamicFeatures) {
          window.initializeDynamicFeatures();
        }
        skipBtn.style.opacity = 0;
        skipBtn.disabled = true;
        clearTimeout(skipTimeout);
        clearTimeout(fallbackTimeout);
        mainContent.style.display = 'block';
        body.style.overflow = '';
        introActive = false;
        replayBtn.style.display = '';
        
        // Create and inject footer when intro ends
        if (!document.getElementById('site-footer')) {
          const footer = document.createElement('footer');
          footer.id = 'site-footer';
          footer.innerHTML = `
            <div class="footer-content">
              <div class="footer-title">The Poradas - established 2025</div>
              <div class="footer-counter">
                <div id="visitor-counter">
                  <span id="total-visitors">0</span> visits
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(footer);
          console.log('[Footer] Footer created and added after intro ended');
        }
        
        // Inject main content after intro is done
        if (!document.getElementById('family-tree')) {
          const template = document.getElementById('main-template');
          if (template) {
            mainContent.appendChild(template.content.cloneNode(true));
            if (window.initializeDynamicFeatures) {
              window.initializeDynamicFeatures();
            }
          }
        }
        // Now run scroll video lazy load logic
        const scrollSection = document.getElementById('scroll-section');
        if ('IntersectionObserver' in window && scrollSection) {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                let scrollVideo = document.getElementById('scroll-video');
                if (!scrollVideo) {
                  scrollVideo = document.createElement('video');
                  scrollVideo.id = 'scroll-video';
                  scrollVideo.preload = 'none';
                  scrollVideo.playsInline = true;
                  scrollVideo.muted = true;
                  scrollVideo.loop = true;
                  scrollVideo.style.background = '#fff';
                  scrollVideo.style.width = '100%';
                  scrollVideo.style.display = 'block';
                  const source = document.createElement('source');
                  source.type = 'video/mp4';
                  source.src = 'video/scroll.mp4';
                  scrollVideo.appendChild(source);
                  scrollSection.appendChild(scrollVideo);
                }
                scrollVideo.load();
                scrollVideo.play().catch(()=>{});
                observer.disconnect();
              }
            });
          }, { threshold: 0.1 });
          observer.observe(scrollSection);
        }
        // Scroll to scroll-section after intro, but NOT if user skipped
        // Only scroll once, either on skip or on video end, not both
        if (scrollSection && !window._hasScrolledToScrollSection) {
          setTimeout(() => {
            scrollSection.scrollIntoView({ behavior: 'smooth' });
            window._hasScrolledToScrollSection = true;
          }, 100); // slight delay to ensure content is visible
        }
        console.log('endIntro called');
      }

      // Fallback: if video doesn't start loading in 3s, skip intro
      fallbackTimeout = setTimeout(() => {
        if (!videoStarted) {
          endIntro();
        }
      }, 3000);

      skipBtn.onclick = function() {
        introWasSkipped = true;
        endIntro();
      };
      introVideo.onended = endIntro;

      // Show skip after 5s of playback
      introVideo.addEventListener('play', function onPlayOnce() {
        videoStarted = true;
        clearTimeout(fallbackTimeout);
        skipTimeout = setTimeout(showSkipBtn, 5000);
        introVideo.removeEventListener('play', onPlayOnce);
      });

      // Try to play video
      const playPromise = introVideo.play();
      if (playPromise !== undefined) {
        playPromise.catch(() => {
          const unlockPlayback = () => {
            introVideo.muted = true;
            introVideo.setAttribute('muted', '');
            introVideo.play();
            body.removeEventListener('click', unlockPlayback);
            body.removeEventListener('touchstart', unlockPlayback);
          }
          body.addEventListener('click', unlockPlayback, { once: true });
          body.addEventListener('touchstart', unlockPlayback, { once: true });
        });
      }

      // Replay intro logic
      replayBtn.onclick = function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        introVideo.currentTime = 0;
        introVideo.play();
        skipBtn.style.opacity = 0;
        skipBtn.disabled = false;
        body.style.overflow = 'hidden';
        mainContent.style.display = 'none';
        introActive = true;
        fallbackTimeout = setTimeout(() => {
          if (!videoStarted) {
            endIntro();
          }
        }, 3000);
      };
    });
  </script>
  <script src="js/main.js?v=super-visible-markers"></script>
  
  <!-- INLINE CHAPTER MARKER FIX - BYPASSES CACHE -->
  <script>
    console.log('🚀 INLINE CHAPTER MARKER FIX LOADED 🚀');
    
    // Override the initialization after a delay to ensure Video.js is ready
    setTimeout(() => {
      console.log('🔧 Starting inline chapter marker fix...');
      
      // Find the video player
      const videoElement = document.getElementById('main-film-video');
      if (!videoElement) {
        console.log('❌ Video element not found');
        return;
      }
      
      // Wait for videojs to be available
      if (typeof videojs === 'undefined') {
        console.log('❌ Video.js not loaded yet, retrying in 2s...');
        setTimeout(arguments.callee, 2000);
        return;
      }
      
      console.log('✅ Video.js found, getting player...');
      const player = videojs('main-film-video');
      
      player.ready(() => {
        console.log('✅ Player ready, adding inline chapter markers...');
        
        // Find chapters track
        let chaptersTrack = null;
        const tracks = player.textTracks();
        for (let i = 0; i < tracks.length; i++) {
          if (tracks[i].kind === 'chapters') {
            tracks[i].mode = 'disabled';
            chaptersTrack = tracks[i];
            console.log(`✅ Found chapters track: ${tracks[i].label}`);
            break;
          }
        }
        
        if (!chaptersTrack) {
          console.log('❌ No chapters track found');
          return;
        }
        
        const addInlineMarkers = () => {
          const duration = player.duration();
          console.log(`📊 Current duration: ${duration} seconds`);
          
          if (!duration || duration === 0) {
            console.log('⏳ Duration not ready, retrying...');
            setTimeout(addInlineMarkers, 1000);
            return;
          }
          
          // Find progress holder
          const playerEl = player.el();
          const progressHolder = playerEl.querySelector('.vjs-progress-holder');
          
          if (!progressHolder) {
            console.log('❌ Progress holder not found, retrying...');
            setTimeout(addInlineMarkers, 1000);
            return;
          }
          
          console.log('✅ Progress holder found:', progressHolder);
          progressHolder.style.position = 'relative';
          
          // Remove existing markers
          const existing = progressHolder.querySelectorAll('.inline-chapter-marker');
          existing.forEach(m => m.remove());
          console.log(`🧹 Removed ${existing.length} existing markers`);
          
          // Check for cues
          if (!chaptersTrack.cues || chaptersTrack.cues.length === 0) {
            console.log('⏳ No cues loaded, retrying...');
            setTimeout(addInlineMarkers, 1000);
            return;
          }
          
          console.log(`📋 Found ${chaptersTrack.cues.length} chapters`);
          
          let added = 0;
          Array.from(chaptersTrack.cues).forEach((cue, index) => {
            console.log(`🔍 Chapter ${index + 1}: "${cue.text}" at ${cue.startTime}s`);
            
            // Only add markers within video duration
            if (cue.startTime > duration) {
              console.log(`⏭️ Skipping - beyond duration`);
              return;
            }
            
            const percent = (cue.startTime / duration) * 100;
            // Use actual positioning, but ensure 0% markers are at least 0.5% visible
            const adjustedPercent = Math.max(percent, 0.5);
            
            const marker = document.createElement('div');
            marker.className = 'inline-chapter-marker';
            marker.setAttribute('data-chapter', cue.text);
            marker.setAttribute('data-time', cue.startTime);
            
            // Final sage green styling to match the site
            marker.style.cssText = `
              position: absolute !important;
              left: ${adjustedPercent}% !important;
              top: 0 !important;
              width: 3px !important;
              height: 100% !important;
              background: #8fa382 !important;
              opacity: 0.9 !important;
              pointer-events: none !important;
              z-index: 15 !important;
              display: block !important;
              border-radius: 1px !important;
            `;
            
            progressHolder.appendChild(marker);
            added++;
            console.log(`✅ Added marker ${added}: "${cue.text}" at ${adjustedPercent.toFixed(1)}% (${cue.startTime}s)`);
          });
          
          console.log(`🎉 FINAL: Added ${added} chapter markers with sage green styling!`);
          
          // Final verification
          const finalMarkers = progressHolder.querySelectorAll('.inline-chapter-marker');
          console.log(`🔍 Verification: ${finalMarkers.length} markers in DOM`);
          finalMarkers.forEach((marker, i) => {
            const rect = marker.getBoundingClientRect();
            console.log(`📐 Marker ${i+1} rect: w=${rect.width}, h=${rect.height}, x=${rect.left}`);
          });
        };
        
        // Try adding markers with multiple triggers
        setTimeout(addInlineMarkers, 1000);
        player.one('loadedmetadata', () => {
          console.log('📊 Metadata loaded');
          setTimeout(addInlineMarkers, 500);
        });
        player.one('play', () => {
          console.log('▶️ Play started');
          setTimeout(addInlineMarkers, 500);
        });
      });
    }, 3000);
  </script>
  <script>
    // Ensure dynamic features always initialize if main content is present
    if (document.getElementById('family-tree') && window.initializeDynamicFeatures) {
      console.log('[DEBUG] Calling initializeDynamicFeatures from index.html');
      window.initializeDynamicFeatures();
    }
  </script>
</body>
</html>